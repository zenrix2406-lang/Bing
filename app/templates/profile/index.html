{% extends "base.html" %}
{% block title %}Profile & Settings — PyHost{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <h4 class="fw-bold mb-4">
      <i class="bi bi-person-circle me-2 text-primary"></i>Profile &amp; Settings
    </h4>

    <!-- Profile info -->
    <div class="card bg-dark border-secondary mb-4">
      <div class="card-header border-secondary py-2">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-person me-1"></i>Account Info</h6>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('profile.index') }}">
          <input type="hidden" name="action" value="update_profile" />
          <div class="row g-3">
            <div class="col-md-6">
              <label for="username" class="form-label">Username</label>
              <input type="text" id="username" name="username"
                     class="form-control bg-secondary border-0 text-white"
                     value="{{ current_user.username }}" required minlength="3" />
            </div>
            <div class="col-md-6">
              <label for="email" class="form-label">Email</label>
              <input type="email" id="email" name="email"
                     class="form-control bg-secondary border-0 text-white"
                     value="{{ current_user.email }}" required />
            </div>
          </div>
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-1"></i>Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Change password -->
    <div class="card bg-dark border-secondary mb-4">
      <div class="card-header border-secondary py-2">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-key me-1"></i>Change Password</h6>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('profile.index') }}">
          <input type="hidden" name="action" value="change_password" />
          <div class="row g-3">
            <div class="col-md-4">
              <label for="current_password" class="form-label">Current Password</label>
              <input type="password" id="current_password" name="current_password"
                     class="form-control bg-secondary border-0 text-white"
                     placeholder="••••••••" required />
            </div>
            <div class="col-md-4">
              <label for="new_password" class="form-label">New Password</label>
              <input type="password" id="new_password" name="new_password"
                     class="form-control bg-secondary border-0 text-white"
                     placeholder="••••••••" required minlength="6" />
            </div>
            <div class="col-md-4">
              <label for="confirm_password" class="form-label">Confirm New Password</label>
              <input type="password" id="confirm_password" name="confirm_password"
                     class="form-control bg-secondary border-0 text-white"
                     placeholder="••••••••" required />
            </div>
          </div>
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-warning">
              <i class="bi bi-shield-lock me-1"></i>Change Password
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- AI API Keys -->
    <div class="card bg-dark border-secondary">
      <div class="card-header border-secondary py-2">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-key-fill me-1 text-info"></i>AI Provider API Keys</h6>
      </div>
      <div class="card-body">
        <p class="text-secondary small mb-3">
          Your keys are stored in the database and used only when you send a message.
          They are never shared. Leave a field blank to clear a key.
        </p>
        <form method="POST" action="{{ url_for('profile.index') }}">
          <input type="hidden" name="action" value="update_api_keys" />

          {% set providers = [
            ('openai_key',    'OpenAI (GPT-4o)',               'bi-lightning-charge-fill text-success',  current_user.openai_key),
            ('anthropic_key', 'Anthropic (Claude 3.5 Sonnet)', 'bi-cloud-fill text-warning',              current_user.anthropic_key),
            ('google_key',    'Google (Gemini 1.5 Pro)',        'bi-google text-danger',                   current_user.google_key),
            ('groq_key',      'Groq (LLaMA 3.3 70B)',          'bi-cpu-fill text-info',                   current_user.groq_key),
            ('mistral_key',   'Mistral (Mistral Large)',        'bi-wind text-purple',                     current_user.mistral_key),
          ] %}

          <div class="row g-3">
            {% for field_name, label, icon_class, key_val in providers %}
            <div class="col-md-6">
              <label for="{{ field_name }}" class="form-label small">
                <i class="bi {{ icon_class }} me-1"></i>{{ label }}
              </label>
              <div class="input-group">
                <input type="password" id="{{ field_name }}" name="{{ field_name }}"
                       class="form-control bg-secondary border-0 text-white font-monospace"
                       placeholder="Paste your API key…"
                       value="{{ key_val or '' }}"
                       autocomplete="off" />
                <button type="button" class="btn btn-secondary toggle-key-btn"
                        data-target="{{ field_name }}" title="Show/hide">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              {% if key_val %}
              <div class="form-text text-success small">
                <i class="bi bi-check-circle me-1"></i>Key configured
              </div>
              {% else %}
              <div class="form-text text-secondary small">Not set</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>

          <div class="mt-4 text-end">
            <button type="submit" class="btn btn-info text-dark fw-semibold">
              <i class="bi bi-save me-1"></i>Save API Keys
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.querySelectorAll('.toggle-key-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const input = document.getElementById(this.dataset.target);
      const icon = this.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
      }
    });
  });
</script>
{% endblock %}
