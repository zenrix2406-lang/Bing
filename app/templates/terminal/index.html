{% extends "base.html" %}
{% block title %}Kali Terminal — PyHost{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<style>
/* ── Kali Linux Terminal Styling ──────────────────────────────── */
.kali-terminal-wrapper {
  background: #000000;
  border-radius: 0.5rem;
  border: 1px solid #1a3a1a;
  overflow: hidden;
  box-shadow: 0 0 30px rgba(0, 255, 0, 0.05), 0 4px 24px rgba(0,0,0,.6);
}
.kali-titlebar {
  background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
  padding: 0.45rem 0.75rem;
  border-bottom: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.kali-titlebar .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.kali-titlebar .dot-close  { background: #ff5f57; }
.kali-titlebar .dot-min    { background: #febc2e; }
.kali-titlebar .dot-max    { background: #28c840; }
.kali-titlebar .kali-title {
  color: #aaa;
  font-size: 0.78rem;
  font-family: 'JetBrains Mono', 'Fira Code', monospace;
  margin-left: auto;
  margin-right: auto;
}
#terminal {
  padding: 0.25rem;
  background: #000000;
}
.kali-toolbar {
  background: #0a0a0a;
  border-top: 1px solid #1a3a1a;
  padding: 0.5rem 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.kali-toolbar .badge { font-size: 0.7rem; }
.kali-info-card {
  background: #0a0f0a;
  border: 1px solid #1a3a1a;
  border-radius: 0.5rem;
}
.kali-info-card .card-header {
  background: #0d120d;
  border-bottom: 1px solid #1a3a1a;
  color: #3fb950;
}
.kali-cmd-btn {
  background: #0d120d;
  border: 1px solid #1a3a1a;
  color: #3fb950;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  transition: background .15s, border-color .15s;
}
.kali-cmd-btn:hover {
  background: #1a3a1a;
  border-color: #3fb950;
  color: #56d364;
}
.kali-section-title {
  color: #3fb950;
  font-size: 0.8rem;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.5px;
}
</style>
{% endblock %}

{% block main_class %}container-fluid py-3{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="fw-bold mb-0">
    <i class="bi bi-terminal-fill me-2" style="color:#3fb950"></i>
    <span style="color:#3fb950">Kali</span> Terminal
  </h4>
  <div class="d-flex gap-2 align-items-center">
    <span id="term-status" class="badge bg-secondary">Connecting…</span>
    <button id="clear-term-btn" class="btn btn-sm kali-cmd-btn">
      <i class="bi bi-eraser me-1"></i>Clear
    </button>
    <button id="reconnect-btn" class="btn btn-sm kali-cmd-btn">
      <i class="bi bi-arrow-clockwise me-1"></i>Reconnect
    </button>
  </div>
</div>

<div class="kali-terminal-wrapper">
  <div class="kali-titlebar">
    <span class="dot dot-close"></span>
    <span class="dot dot-min"></span>
    <span class="dot dot-max"></span>
    <span class="kali-title">{{ current_user.username }}@web: ~</span>
  </div>
  <div id="terminal"></div>
  <div class="kali-toolbar">
    <span class="badge" style="background:#1a3a1a;color:#3fb950">
      <i class="bi bi-shield-fill-check me-1"></i>PTY Shell
    </span>
    <span class="badge" style="background:#1a1a2e;color:#58a6ff">
      <i class="bi bi-hdd-network me-1"></i>{{ current_user.username }}@web
    </span>
    <span class="badge" style="background:#1a1a1a;color:#888" id="term-size">80×24</span>
  </div>
</div>

<div class="mt-3 row g-3">
  <div class="col-lg-4">
    <div class="card kali-info-card">
      <div class="card-header py-2">
        <span class="kali-section-title"><i class="bi bi-terminal me-1"></i>Quick Commands</span>
      </div>
      <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-1">
          {% for cmd in [
            ('ls -la', 'ls -la'),
            ('pwd', 'pwd'),
            ('whoami', 'whoami'),
            ('id', 'id'),
            ('uname -a', 'uname -a'),
            ('cat /etc/os-release', 'cat /etc/os-release'),
            ('ps aux', 'ps aux'),
            ('df -h', 'df -h'),
            ('free -h', 'free -h'),
            ('env', 'env'),
            ('history', 'history'),
            ('date', 'date'),
          ] %}
          <button class="btn btn-sm kali-cmd-btn quick-cmd" data-cmd="{{ cmd[1] }}">{{ cmd[0] }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card kali-info-card">
      <div class="card-header py-2">
        <span class="kali-section-title"><i class="bi bi-code-slash me-1"></i>Python</span>
      </div>
      <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-1">
          {% for cmd in [
            ('python3', 'python3'),
            ('python3 --version', 'python3 --version'),
            ('pip list', 'pip list'),
            ('pip install ', 'pip install '),
            ('pip3 --version', 'pip3 --version'),
          ] %}
          <button class="btn btn-sm kali-cmd-btn quick-cmd" data-cmd="{{ cmd[1] }}">{{ cmd[0] }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card kali-info-card">
      <div class="card-header py-2">
        <span class="kali-section-title"><i class="bi bi-lightbulb me-1"></i>Tips</span>
      </div>
      <div class="card-body py-2 small" style="color:#5a8a5a">
        <ul class="mb-0 ps-3">
          <li>Type <code style="color:#3fb950">python3</code> for interactive Python</li>
          <li>Use <code style="color:#3fb950">pip install &lt;pkg&gt;</code> to install packages</li>
          <li>Press <kbd>Ctrl+C</kbd> to cancel a command</li>
          <li>Use <kbd>Tab</kbd> for autocomplete</li>
          <li>Press <kbd>Ctrl+L</kbd> to clear screen</li>
          <li><kbd>↑</kbd>/<kbd>↓</kbd> to navigate history</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
<script src="https://cdn.jsdelivr.net/npm/socket.io@4.7.4/dist/socket.io.min.js"></script>
<script>
(function() {
  'use strict';

  /* ── Kali Linux xterm theme ───────────────────────────────── */
  const term = new Terminal({
    fontFamily: "'JetBrains Mono', 'Fira Code', 'Cascadia Code', Consolas, monospace",
    fontSize: 14,
    lineHeight: 1.35,
    cursorBlink: true,
    cursorStyle: 'block',
    theme: {
      background: '#000000',
      foreground: '#00ff41',
      cursor: '#00ff41',
      cursorAccent: '#000000',
      selectionBackground: '#1a3a1a',
      selectionForeground: '#00ff41',
      black:   '#000000',
      red:     '#ff5555',
      green:   '#3fb950',
      yellow:  '#f1fa8c',
      blue:    '#6272a4',
      magenta: '#ff79c6',
      cyan:    '#8be9fd',
      white:   '#bfbfbf',
      brightBlack:   '#555555',
      brightRed:     '#ff6e6e',
      brightGreen:   '#56d364',
      brightYellow:  '#ffffa5',
      brightBlue:    '#79c0ff',
      brightMagenta: '#ff92df',
      brightCyan:    '#a4ffff',
      brightWhite:   '#ffffff',
    },
    allowProposedApi: true,
    scrollback: 5000,
  });

  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(document.getElementById('terminal'));
  fitAddon.fit();

  const statusEl = document.getElementById('term-status');
  const sizeEl   = document.getElementById('term-size');

  function setStatus(text, cls) {
    statusEl.textContent = text;
    statusEl.className = 'badge ' + cls;
  }

  /* ── SocketIO connection ─────────────────────────────────── */
  let socket;
  function connect() {
    setStatus('Connecting…', 'bg-secondary');
    socket = io('/terminal', { transports: ['websocket'] });

    socket.on('connect', function() {
      setStatus('Connected', 'bg-success');
      term.focus();
    });

    socket.on('disconnect', function() {
      setStatus('Disconnected', 'bg-danger');
    });

    socket.on('terminal_output', function(data) {
      term.write(data.data);
    });

    socket.on('connect_error', function(err) {
      setStatus('Error', 'bg-danger');
      term.write('\r\n\x1b[31mConnection error: ' + err.message + '\x1b[0m\r\n');
    });
  }

  connect();

  term.onData(function(data) {
    if (socket && socket.connected) {
      socket.emit('terminal_input', { data: data });
    }
  });

  function sendResize() {
    fitAddon.fit();
    if (sizeEl) {
      sizeEl.textContent = term.cols + '×' + term.rows;
    }
    if (socket && socket.connected) {
      socket.emit('terminal_resize', { rows: term.rows, cols: term.cols });
    }
  }

  window.addEventListener('resize', sendResize);

  /* ── Quick command buttons ───────────────────────────────── */
  document.querySelectorAll('.quick-cmd').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var cmd = btn.dataset.cmd;
      if (socket && socket.connected) {
        socket.emit('terminal_input', { data: cmd + (cmd.endsWith(' ') ? '' : '\n') });
        term.focus();
      }
    });
  });

  document.getElementById('clear-term-btn').addEventListener('click', function() {
    term.clear();
    term.focus();
  });

  document.getElementById('reconnect-btn').addEventListener('click', function() {
    if (socket) socket.disconnect();
    term.write('\r\n\x1b[33m[Reconnecting…]\x1b[0m\r\n');
    setTimeout(connect, 500);
  });

  setTimeout(sendResize, 100);
})();
</script>
{% endblock %}
